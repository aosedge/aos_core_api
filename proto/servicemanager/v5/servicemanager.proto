syntax = "proto3";

package servicemanager.v5;

import "google/protobuf/timestamp.proto";
import "common/v2/common.proto";

/***********************************************************************************************************************
 * SMService
 **********************************************************************************************************************/

service SMService {
    rpc RegisterSM(stream SMOutgoingMessages) returns (stream SMIncomingMessages) {}
    rpc GetItemImageInfo(ItemImageInfoRequest) returns (ItemImageInfo) {}
    rpc GetLayerImageInfo(LayerImageInfoRequest) returns (ItemImageInfo) {}
}

service ProxyService {
    rpc RegisterSM(stream ProxyOutgoingMessages) returns (stream ProxyIncomingMessages) {}
}

message SMIncomingMessages {
    oneof SMIncomingMessage {
        GetNodeConfigStatus     get_node_config_status     = 1;
        CheckNodeConfig         check_node_config          = 2;
        SetNodeConfig           set_node_config            = 3;
        UpdateInstances         update_instances           = 4;
        OverrideEnvVars         override_env_vars          = 5;
        SystemLogRequest        system_log_request         = 6;
        InstanceLogRequest      instance_log_request       = 7;
        InstanceCrashLogRequest instance_crash_log_request = 8;
        GetAverageMonitoring    get_average_monitoring     = 9;
        ConnectionStatus        connection_status          = 10;
        UpdateNetworks          update_networks            = 11;
    }
}

message ProxyIncomingMessages {
    oneof ProxyIncomingMessage {
        ImageContentInfo image_content_info = 1;
        ImageContent     image_content      = 2;
        ClockSync        clock_sync         = 3;
    }
}

message SMOutgoingMessages {
    oneof SMOutgoingMessage {
        SMInfo                sm_info                 = 1;
        NodeConfigStatus      node_config_status      = 2;
        UpdateInstancesStatus update_instances_status = 3;
        NodeInstancesStatus   node_instances_status   = 4;
        OverrideEnvVarStatus  override_env_var_status = 5;
        LogData               log                     = 6;
        InstantMonitoring     instant_monitoring      = 7;
        AverageMonitoring     average_monitoring      = 8;
        Alert                 alert                   = 9;
    }
}

message ProxyOutgoingMessages {
    oneof ProxyOutgoingMessage {
        string              node_id               = 1;
        ImageContentRequest image_content_request = 2;
        ClockSyncRequest    clock_sync_request    = 3;
    }
}

message ItemImageInfoRequest {
    string image_id = 1;
}

message LayerImageInfoRequest {
    string digest = 1;
}

message ItemImageInfo {
    string image_id = 1;
    string version  = 2;
    string url      = 3;
    bytes  sha256   = 4;
    uint64 size     = 5;
}

message GetNodeConfigStatus {}

message CheckNodeConfig {
    string node_config = 1;
    string version     = 2;
}

message SetNodeConfig {
    string node_config = 1;
    string version     = 2;
}

message InstanceInfo {
    common.v2.InstanceIdent instance           = 1;
    string                  runtime_id         = 2;
    uint32                  uid                = 3;
    uint32                  gid                = 4;
    uint64                  priority           = 5;
    string                  storage_path       = 6;
    string                  state_path         = 7;
    NetworkParameters       network_parameters = 8;
}

message UpdateInstances {
    repeated InstanceInfo start_instances           = 1;
    repeated common.v2.InstanceIdent stop_instances = 2;
}

message EnvVarInfo {
    string                    name  = 1;
    string                    value = 2;
    google.protobuf.Timestamp ttl   = 3;
}

message OverrideInstanceEnvVar {
    common.v2.InstanceFilter instance_filter = 1;
    repeated EnvVarInfo      variables       = 2;
}

message OverrideEnvVars {
    repeated OverrideInstanceEnvVar env_vars = 1;
}

message SystemLogRequest {
    string                    log_id = 1;
    google.protobuf.Timestamp from   = 2;
    google.protobuf.Timestamp till   = 3;
}

message InstanceLogRequest {
    string                    log_id = 1;
    common.v2.InstanceFilter  filter = 2;
    google.protobuf.Timestamp from   = 3;
    google.protobuf.Timestamp till   = 4;
}

message InstanceCrashLogRequest {
    string                    log_id = 1;
    common.v2.InstanceFilter  filter = 2;
    google.protobuf.Timestamp from   = 3;
    google.protobuf.Timestamp till   = 4;
}

message GetAverageMonitoring {}

enum ConnectionEnum {
    DISCONNECTED = 0;
    CONNECTED    = 1;
}

message ConnectionStatus {
    ConnectionEnum cloud_status = 1;
}

message ImageContentInfo {
    uint64              request_id  = 1;
    repeated ImageFile  image_files = 2;
    common.v2.ErrorInfo error       = 3;
}

message ImageFile {
    string relative_path = 1;
    bytes  sha256        = 2;
    uint64 size          = 3;
}

message ImageContent {
    uint64 request_id    = 1;
    string relative_path = 2;
    uint64 parts_count   = 3;
    uint64 part          = 4;
    bytes  data          = 5;
}

message FirewallRule {
    string dst_ip   = 1;
    string dst_port = 2;
    string proto    = 3;
    string src_ip   = 4;
}

message NetworkParameters {
    string                network_id  = 1;
    string                subnet      = 2;
    string                ip          = 3;
    repeated string       dns_servers = 5;
    repeated FirewallRule rules       = 6;
}

message UpdateNetworkParameters {
    string network_id = 1;
    string subnet     = 2;
    string ip         = 3;
    uint64 vlan_id    = 4;
}

message UpdateNetworks {
    repeated UpdateNetworkParameters networks = 1;
}

message ClockSync {
    google.protobuf.Timestamp current_time = 1;
}

message ResourceInfo {
    string name         = 1;
    uint64 shared_count = 2;
}

message RuntimeInfo {
    string runtime_id    = 1;
    string type          = 2;
    uint64 max_dmips     = 3;
    uint64 allowed_dmips = 4;
    uint64 total_ram     = 5;
    uint64 allowed_ram   = 6;
    uint64 max_instances = 7;
}

message SMInfo {
    string                node_id   = 1;
    repeated RuntimeInfo  runtimes  = 2;
    repeated ResourceInfo resources = 3;
}

message NodeConfigStatus {
    string              state   = 1;
    string              version = 2;
    common.v2.ErrorInfo error   = 3;
}

message InstanceStatus {
    common.v2.InstanceIdent instance   = 1;
    string                  version    = 2;
    string                  runtime_id = 3;
    string                  image_id   = 4;
    string                  state      = 5;
    common.v2.ErrorInfo     error      = 6;
}

message UpdateInstancesStatus {
    repeated InstanceStatus instances = 1;
}

message NodeInstancesStatus {
    repeated InstanceStatus instances = 1;
}

message EnvVarStatus {
    string              name  = 1;
    common.v2.ErrorInfo error = 2;
}

message EnvVarInstanceStatus {
    common.v2.InstanceIdent instance = 1;
    repeated EnvVarStatus   statuses = 2;
}

message OverrideEnvVarStatus {
    repeated EnvVarInstanceStatus instances = 1;
}

message LogData {
    string              log_id     = 1;
    uint64              part_count = 2;
    uint64              part       = 3;
    bytes               data       = 4;
    string              status     = 5;
    common.v2.ErrorInfo error      = 6;
}

message PartitionUsage {
    string name      = 1;
    uint64 used_size = 2;
}

message MonitoringData {
    google.protobuf.Timestamp timestamp  = 1;
    uint64                    ram        = 2;
    uint64                    cpu        = 3;
    repeated PartitionUsage   partitions = 4;
    uint64                    download   = 5;
    uint64                    upload     = 6;
}

message InstanceMonitoring {
    common.v2.InstanceIdent instance        = 1;
    string                  runtime_id      = 2;
    MonitoringData          monitoring_data = 3;
}

message InstantMonitoring {
    MonitoringData              node_monitoring      = 1;
    repeated InstanceMonitoring instances_monitoring = 2;
}

message AverageMonitoring {
    MonitoringData              node_monitoring      = 1;
    repeated InstanceMonitoring instances_monitoring = 2;
}

message SystemQuotaAlert {
    string parameter = 1;
    uint64 value     = 2;
    string status    = 3;
}

message InstanceQuotaAlert {
    common.v2.InstanceIdent instance  = 1;
    string                  parameter = 2;
    uint64                  value     = 3;
    string                  status    = 4;
}

message ResourceAllocateAlert {
    common.v2.InstanceIdent instance = 1;
    string                  resource = 2;
    string                  message  = 3;
}

message ResourceValidateAlert {
    string   name                       = 1;
    repeated common.v2.ErrorInfo errors = 2;
}

message SystemAlert {
    string message = 1;
}

message CoreAlert {
    string core_component = 1;
    string message        = 2;
}

message InstanceAlert {
    common.v2.InstanceIdent instance        = 1;
    string                  service_version = 2;
    string                  message         = 3;
}

message Alert {
    google.protobuf.Timestamp timestamp = 1;
    oneof                     AlertItem {
        SystemQuotaAlert      system_quota_alert      = 2;
        InstanceQuotaAlert    instance_quota_alert    = 3;
        ResourceValidateAlert resource_validate_alert = 4;
        ResourceAllocateAlert resource_allocate_alert = 5;
        SystemAlert           system_alert            = 6;
        CoreAlert             core_alert              = 7;
        InstanceAlert         instance_alert          = 8;
    }
}

message ImageContentRequest {
    string url          = 1;
    uint64 request_id   = 2;
    string content_type = 3;
}

message ClockSyncRequest {}
